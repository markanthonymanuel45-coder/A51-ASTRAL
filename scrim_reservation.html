<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CODM Scrim Slot Reservation</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg, #0b0f14 0%, #05060a 100%);
      color: #e6eef8;
    }

    .container {
      max-width: 960px;
      margin: 40px auto;
      padding: 24px;
      background: linear-gradient(180deg, #0f1720, #071019);
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
    }

    h2 {
      text-align: center;
      font-size: 28px;
      margin-bottom: 20px;
      color: #2ecc71;
      text-shadow: 0 0 6px rgba(46, 204, 113, 0.5);
    }

    /* ‚îÄ‚îÄ Sticky Status Banner ‚îÄ‚îÄ */
    #statusBanner {
      position: sticky;
      top: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 12px 20px;
      border-radius: 12px;
      margin: 0 0 24px;
      font-weight: 700;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #statusBanner.open {
      background: rgba(46, 204, 113, 0.15);
      border-color: rgba(46, 204, 113, 0.4);
      color: #2ecc71;
    }

    #statusBanner.closed {
      background: rgba(231, 76, 60, 0.1);
      border-color: rgba(231, 76, 60, 0.3);
      color: #e74c3c;
    }

    .status-main {
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-sub {
      font-size: 12px;
      opacity: 0.9;
      font-weight: 500;
      color: #94a3b8;
    }

    .pulse-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: currentColor;
      box-shadow: 0 0 8px currentColor;
    }

    .open .pulse-dot {
      animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
      }

      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
      }
    }

    .buttons {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    button {
      padding: 12px 20px;
      font-weight: 700;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn {
      padding: 10px 16px;
      font-weight: 700;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.05);
      color: #cbd5e1;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #mineBtn {
      background: #2ecc71;
      color: #0b0f14;
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
    }

    #mineBtn:hover:not(:disabled) {
      background: #27ae60;
      transform: translateY(-2px);
    }

    #mineBtn:disabled {
      background: #374151;
      color: #94a3b8;
      box-shadow: none;
      cursor: not-allowed;
    }

    #cancelBtn {
      background: #e74c3c;
      color: #fff;
      margin-left: 10px;
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
    }

    #cancelBtn:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    #slots {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .slot {
      background: rgba(255, 255, 255, 0.03);
      min-height: 80px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: 0.2s;
      font-weight: 600;
      text-align: center;
      box-shadow: inset 0 0 4px rgba(255, 255, 255, 0.05);
    }

    .slot.empty {
      background: linear-gradient(180deg, #39424a, #2c3238);
      color: #94a3b8;
    }

    .slot.filled {
      background: linear-gradient(180deg, #063a1b, #094b23);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .slot:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    .slot .num {
      font-weight: 700;
      font-size: 14px;
    }

    .slot .clan {
      font-size: 14px;
      margin-top: 4px;
      color: inherit;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 90%;
    }

    .slot-logo {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      border: 2px solid rgba(46, 204, 113, 0.3);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .slot-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Upload Preview in Modal */
    #logoPreviewContainer {
      width: 80px;
      height: 80px;
      margin: 10px auto 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.05);
      border: 2px dashed #94a3b8;
      display: none;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: border-color 0.2s, background 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    #logoPreviewContainer:hover {
      border-color: #2ecc71;
      background: rgba(46, 204, 113, 0.1);
    }

    #logoPreview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .upload-hint {
      font-size: 10px;
      color: #94a3b8;
      margin-bottom: 10px;
    }

    /* MODAL */
    #clanModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 32, 0.85);
      backdrop-filter: blur(6px);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    #clanModalContent {
      background: radial-gradient(circle at top, #1f2933 0%, #020617 55%);
      padding: 20px 20px 16px;
      border-radius: 16px;
      width: 320px;
      text-align: center;
      position: relative;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    #clanModalContent h3 {
      color: #2ecc71;
      margin-bottom: 12px;
    }

    #clanInput {
      width: 92%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.8);
      color: #e6eef8;
      margin: 0 auto 10px;
      font-size: 14px;
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, transform 0.15s ease;
    }

    #clanInput::placeholder {
      color: #64748b;
    }

    #clanInput:focus {
      border-color: #2ecc71;
      box-shadow: 0 0 0 1px rgba(46, 204, 113, 0.45), 0 10px 30px rgba(15, 23, 42, 0.7);
      background: rgba(15, 23, 42, 1);
      transform: translateY(-1px);
    }

    #modalButtons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    #submitClan {
      flex: 1;
      background: #2ecc71;
      color: #0b0f14;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-weight: 700;
      cursor: pointer;
    }

    #cancelClan {
      flex: 1;
      background: #ccc;
      color: #0b0f14;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-weight: 700;
      cursor: pointer;
    }

    #submitClan,
    #cancelClan {
      transition: background 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
    }

    #submitClan:hover {
      background: #27ae60;
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(46, 204, 113, 0.4);
    }

    #cancelClan:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.7);
    }

    /* Success Popup */
    .success-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #063a1b;
      border: 2px solid #2ecc71;
      color: #fff;
      padding: 20px 30px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      z-index: 3000;
      box-shadow: 0 8px 30px rgba(46, 204, 113, 0.4);
      animation: popupSlideIn 0.3s ease-out;
    }

    @keyframes popupSlideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -60%);
      }

      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    @media(max-width:640px) {
      .container {
        margin: 10px auto;
        padding: 16px;
        width: 95%;
      }

      h2 {
        font-size: 22px;
      }

      #slots {
        grid-template-columns: repeat(2, 1fr);
      }

      #clanModalContent {
        width: 92%;
        max-height: 90vh;
        overflow-y: auto;
        padding: 18px 16px;
      }

      #logoPreviewContainer {
        width: 70px;
        height: 70px;
      }

      #statusBanner {
        padding: 10px;
        margin-bottom: 16px;
      }

      .status-main {
        font-size: 14px;
      }
    }

    /* Cancel Modal Radio Styles */
    #cancelClanList {
      text-align: left;
      margin: 15px auto;
      max-height: 250px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .clan-option {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .clan-option:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .clan-option input[type="radio"] {
      margin-right: 12px;
      accent-color: #e74c3c;
      transform: scale(1.2);
    }

    #cancelSubmitBtn {
      background: #e74c3c;
      color: white;
    }

    #cancelSubmitBtn:hover {
      background: #c0392b;
      box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4);
    }

    /* Confirmation Modal Styles */
    #confirmModalContent {
      background: radial-gradient(circle at top, #1f2933 0%, #020617 55%);
      padding: 24px;
      border-radius: 16px;
      width: 300px;
      text-align: center;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(231, 76, 60, 0.3);
      animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .confirm-title {
      color: #e74c3c;
      font-size: 18px;
      margin-bottom: 12px;
      font-weight: 700;
    }

    .confirm-text {
      font-size: 14px;
      color: #cbd5e1;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .confirm-buttons {
      display: flex;
      gap: 12px;
    }

    .confirm-btn-yes {
      flex: 1;
      background: #e74c3c;
      color: white;
      padding: 10px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: 0.2s;
    }

    .confirm-btn-yes:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .confirm-btn-no {
      flex: 1;
      background: #4b5563;
      color: white;
      padding: 10px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: 0.2s;
    }

    .confirm-btn-no:hover {
      background: #374151;
      transform: translateY(-2px);
    }

    /* ‚îÄ‚îÄ Sticky Status Pill (Compact & Premium) ‚îÄ‚îÄ */
    #statusBanner {
      position: sticky;
      top: 15px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 32px;
      border-radius: 50px;
      /* Pill Shape */
      margin: 0 auto 28px;
      width: fit-content;
      /* Hindi na pahaba */
      min-width: 240px;
      background: rgba(15, 23, 32, 0.8);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6),
        inset 0 1px 1px rgba(255, 255, 255, 0.1);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #statusBanner.open {
      border-color: rgba(46, 204, 113, 0.4);
      box-shadow: 0 10px 30px rgba(46, 204, 113, 0.15);
    }

    #statusBanner.closed {
      border-color: rgba(231, 76, 60, 0.3);
      box-shadow: 0 10px 30px rgba(231, 76, 60, 0.1);
    }

    .status-main {
      font-size: 13px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 1.5px;
      margin-bottom: 2px;
    }

    .open .status-main {
      color: #2ecc71;
    }

    .closed .status-main {
      color: #e74c3c;
    }

    .status-sub {
      font-size: 11px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.6);
      letter-spacing: 0.5px;
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .open .pulse-dot {
      background: #2ecc71;
      box-shadow: 0 0 12px #2ecc71;
      animation: pulse-ring 2s infinite;
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(0.8);
        opacity: 0.5;
      }

      50% {
        transform: scale(1.1);
        opacity: 1;
      }

      100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
    }

    /* ‚îÄ‚îÄ Schedule Switcher ‚îÄ‚îÄ */
    .sched-switcher {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0;
      margin: 0 auto 22px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 50px;
      padding: 5px;
      width: fit-content;
    }

    .sched-btn {
      position: relative;
      padding: 9px 22px;
      border-radius: 50px;
      font-size: 13px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      background: transparent;
      color: #94a3b8;
      transition: color 0.25s;
      letter-spacing: 0.5px;
      z-index: 1;
    }

    .sched-btn.active {
      background: linear-gradient(135deg, #2ecc71, #16a085);
      color: #0b0f14;
      box-shadow: 0 4px 14px rgba(46, 204, 113, 0.45);
    }

    .sched-divider {
      width: 1px;
      height: 20px;
      background: rgba(255, 255, 255, 0.12);
      margin: 0 2px;
    }
  </style>
</head>

<body>

  <div class="container">
    <h2 id="pageTitle">ASTRAL 51 CODM Scrim Slot Reservation</h2>

    <!-- ‚îÄ‚îÄ Sticky Reservation Status Banner ‚îÄ‚îÄ -->
    <div id="statusBanner" class="closed">
      <div class="status-main">
        <span class="pulse-dot"></span>
        <span id="statusText">Checking status‚Ä¶</span>
      </div>
      <div id="countdownText" class="status-sub"></div>
    </div>

    <!-- Schedule Fast-Switcher -->
    <div class="sched-switcher">
      <button class="sched-btn active" id="schedBtn8pm" onclick="switchSched('8pm')">üåô 8:00 PM</button>
      <div class="sched-divider"></div>
      <button class="sched-btn" id="schedBtn10pm" onclick="switchSched('10pm')">üåÉ 10:00 PM</button>
    </div>

    <div class="buttons">
      <button id="mineBtn">MINE SLOT</button>
      <button id="cancelBtn">CANCEL SLOT</button>
    </div>

    <div id="slots"></div>
  </div>

  <!-- MODAL -->
  <div id="clanModal">
    <div id="clanModalContent">
      <h3>Reserve Slot</h3>
      <div style="margin-bottom: 15px; text-align: left;">
        <label style="font-size: 12px; color: #94a3b8; display: block; margin-bottom: 5px;">Clan Name</label>
        <input type="text" id="clanInput" placeholder="Enter Clan Name" style="width: 100%; box-sizing: border-box;">
      </div>
      <div style="margin-bottom: 20px; text-align: left;">
        <label style="font-size: 12px; color: #94a3b8; display: block; margin-bottom: 5px;">Cancellation PIN (4
          Digits)</label>
        <input type="password" id="pinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          style="width: 100%; box-sizing: border-box; text-align: center; letter-spacing: 5px; font-size: 18px;">
        <small style="font-size: 10px; color: #64748b; display: block; margin-top: 5px;">Choose a PIN to protect your
          slot.</small>
      </div>
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button id="uploadLogoBtn" class="btn btn-ghost" style="flex: 1; font-size: 11px;">
          <span id="uploadStatusText">UPLOAD LOGO</span>
        </button>
        <input type="file" id="logoFile" accept="image/*" style="display:none">
      </div>
      <div id="logoPreviewContainer" onclick="logoFile.click()" title="Tap to change logo">
        <img id="logoPreview" src="" alt="">
      </div>
      <p class="upload-hint">Tap circle to change logo</p>
      <div style="display: flex; gap: 10px;">
        <button id="clanSubmitBtn" class="btn" style="flex: 2; background: #2ecc71; color: #0b0f14;">SUBMIT</button>
        <button id="clanCancelBtn" class="btn btn-ghost" style="flex: 1;">CLOSE</button>
      </div>
    </div>
  </div>

  <!-- CANCEL MODAL -->
  <div id="cancelModal"
    style="display: none; position: fixed; inset: 0; background: rgba(15, 23, 32, 0.85); backdrop-filter: blur(6px); justify-content: center; align-items: center; z-index: 2000;">
    <div id="cancelModalContent"
      style="background: radial-gradient(circle at top, #1f2933 0%, #020617 55%); padding: 20px 20px 16px; border-radius: 16px; width: 320px; text-align: center; position: relative; box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9); border: 1px solid rgba(148, 163, 184, 0.4);">
      <h3>Cancel Reservation</h3>
      <p style="font-size: 12px; color: #94a3b8; margin-bottom: 15px;">Select your clan to cancel your slot:</p>
      <div id="cancelList"
        style="text-align: left; margin-bottom: 20px; max-height: 200px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
      </div>
      <div id="pinVerificationSection"
        style="display:none; margin-top: 15px; text-align: left; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
        <label style="font-size: 12px; color: #94a3b8; display: block; margin-bottom: 5px;">Enter your 4-Digit
          PIN:</label>
        <input type="password" id="cancelPinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          style="width: 100%; box-sizing: border-box; text-align: center; letter-spacing: 5px; font-size: 18px; margin-bottom: 15px;">
      </div>
      <div style="display: flex; gap: 10px;">
        <button id="cancelSubmitBtn" class="btn" style="flex: 2; background: #e74c3c;">SUBMIT CANCELLATION</button>
        <button id="cancelCloseBtn" class="btn btn-ghost" style="flex: 1;">CLOSE</button>
      </div>
    </div>
  </div>

  <!-- CUSTOM CONFIRMATION MODAL -->
  <div id="confirmModal"
    style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); justify-content: center; align-items: center; z-index: 3000;">
    <div id="confirmModalContent">
      <div class="confirm-title">Are you sure?</div>
      <div class="confirm-text" id="confirmMessage">Do you really want to cancel this reservation?</div>
      <div class="confirm-buttons">
        <button id="confirmYes" class="confirm-btn-yes">Yes, Cancel</button>
        <button id="confirmNo" class="confirm-btn-no">No, Go Back</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://yzdtszfubnastllfyczs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6ZHRzemZ1Ym5hc3RsbGZ5Y3pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNzEyOTgsImV4cCI6MjA4NzY0NzI5OH0.GJz1ouXTbi3GQZYJa0756w4CgqabT9C2EH_mW_m_5TY';
    const MAX_SLOTS = 25;

    const slotsEl = document.getElementById('slots');
    const clanModal = document.getElementById('clanModal');
    const clanInput = document.getElementById('clanInput');
    const pinInput = document.getElementById('pinInput');
    const logoFile = document.getElementById('logoFile');
    const uploadLogoBtn = document.getElementById('uploadLogoBtn');
    const uploadStatusText = document.getElementById('uploadStatusText');
    const logoPreview = document.getElementById('logoPreview');
    const logoPreviewContainer = document.getElementById('logoPreviewContainer');
    const clanSubmitBtn = document.getElementById('clanSubmitBtn');
    const clanCancelBtn = document.getElementById('clanCancelBtn');
    const mineBtn = document.getElementById('mineBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const statusText = document.getElementById('statusText');
    const countdownText = document.getElementById('countdownText');
    const statusBanner = document.getElementById('statusBanner');

    let currentLogoBase64 = '';
    let currentSlotToMine = null;
    let selectedSlotIdToCancel = null;
    let currentSlots = [];
    let closeTime = null; // Store as {h, m}
    let openTime = null;  // Store as {h, m}
    let isCurrentlyOpen = false;

    // --- DUAL SCHEDULE LOGIC ---
    const urlParams = new URLSearchParams(window.location.search);
    let currentSched = urlParams.get('sched') || '8pm';
    if (currentSched !== '8pm' && currentSched !== '10pm') currentSched = '8pm';

    function switchSched(sched) {
      currentSched = sched;
      document.getElementById('schedBtn8pm').classList.toggle('active', sched === '8pm');
      document.getElementById('schedBtn10pm').classList.toggle('active', sched === '10pm');
      const title = document.getElementById('pageTitle');
      if (title) title.textContent = `A51 ASTRAL ${sched.toUpperCase()} Scrim Reservation`;
      loadSlots();
      checkStatus();
    }

    // Init active button
    document.getElementById(`schedBtn${currentSched}`).classList.add('active');
    document.getElementById('pageTitle').textContent = `A51 ASTRAL ${currentSched.toUpperCase()} Scrim Reservation`;

    const supabaseHeaders = () => ({
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
    });

    mineBtn.onclick = async () => {
      const empty = currentSlots.find(s => !s.clan);
      if (!empty) { showPopup(`All slots full for ${currentSched.toUpperCase()}!`); return; }
      clanInput.value = '';
      pinInput.value = '';
      currentLogoBase64 = '';
      logoPreview.src = '';
      logoPreviewContainer.style.display = 'none';
      uploadStatusText.textContent = 'UPLOAD LOGO';
      clanModal.style.display = 'flex';
      clanInput.focus();
    }

    uploadLogoBtn.onclick = () => logoFile.click();
    logoFile.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const dataUrl = event.target.result;
          logoPreview.src = dataUrl;
          logoPreviewContainer.style.display = 'flex';
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX = 150;
            let w = img.width, h = img.height;
            if (w > h) { if (w > MAX) { h = h * MAX / w; w = MAX; } }
            else { if (h > MAX) { w = w * MAX / h; h = MAX; } }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            currentLogoBase64 = canvas.toDataURL('image/jpeg', 0.65);
          };
          img.src = dataUrl;
        };
        reader.readAsDataURL(file);
      }
    };

    clanCancelBtn.onclick = () => clanModal.style.display = 'none';

    cancelBtn.onclick = async () => {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/slots?select=id,slot_number,clan,cancel_key&schedule_type=eq.${currentSched}&clan=neq.&clan=not.is.null&order=slot_number.asc`, { headers: supabaseHeaders() });
        const filled = await res.json();
        if (!filled || filled.length === 0) { showPopup("No reservations to cancel!"); return; }
        const cancelList = document.getElementById('cancelList');
        cancelList.innerHTML = '';
        filled.forEach(s => {
          const div = document.createElement('div');
          div.className = 'clan-option';
          div.innerHTML = `<input type="radio" name="cancelSlot" id="slot_${s.id}" value="${s.id}" data-key="${s.cancel_key}" data-name="${s.clan}" data-num="${s.slot_number}">
                           <label for="slot_${s.id}"><span>Slot ${s.slot_number}: ${s.clan}</span></label>`;
          div.querySelector('input').onchange = () => {
            document.getElementById('pinVerificationSection').style.display = 'block';
            document.getElementById('cancelPinInput').focus();
          };
          cancelList.appendChild(div);
        });
        document.getElementById('cancelModal').style.display = 'flex';
      } catch (e) { showPopup('Error loading clans'); }
    };

    document.getElementById('cancelCloseBtn').onclick = () => document.getElementById('cancelModal').style.display = 'none';

    document.getElementById('cancelSubmitBtn').onclick = () => {
      const selected = document.querySelector('input[name="cancelSlot"]:checked');
      if (!selected) { showPopup("Select a slot."); return; }
      if (document.getElementById('cancelPinInput').value !== selected.getAttribute('data-key')) { showPopup("Incorrect PIN!"); return; }
      selectedSlotIdToCancel = selected.value;
      document.getElementById('confirmMessage').innerHTML = `Cancel Slot ${selected.getAttribute('data-num')}: ${selected.getAttribute('data-name')}?`;
      document.getElementById('confirmModal').style.display = 'flex';
    };

    document.getElementById('confirmNo').onclick = () => document.getElementById('confirmModal').style.display = 'none';
    document.getElementById('confirmYes').onclick = async () => {
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/slots?id=eq.${selectedSlotIdToCancel}`, {
          method: 'PATCH',
          headers: { ...supabaseHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ clan: '', clan_logo: null, cancel_key: null }),
        });
        showPopup('Cancelled!');
        document.getElementById('confirmModal').style.display = 'none';
        document.getElementById('cancelModal').style.display = 'none';
        loadSlots();
      } catch (e) { showPopup('Error cancelling'); }
    };

    function showPopup(message) {
      const p = document.createElement('div'); p.className = 'success-popup'; p.textContent = message;
      document.body.appendChild(p); setTimeout(() => p.remove(), 1500);
    }

    clanSubmitBtn.onclick = async () => {
      const clan = clanInput.value.trim();
      const pin = pinInput.value.trim();
      if (!clan || pin.length !== 4) { showPopup('Check clan name and 4-digit PIN!'); return; }
      clanSubmitBtn.disabled = true;
      try {
        const resList = await fetch(`${SUPABASE_URL}/rest/v1/slots?select=id,slot_number,clan&schedule_type=eq.${currentSched}&order=slot_number.asc`, { headers: supabaseHeaders() });
        const list = await resList.json();
        const empty = list.find(r => !r.clan || r.clan.trim() === '');
        if (!empty) { showPopup('Full!'); clanSubmitBtn.disabled = false; return; }
        await fetch(`${SUPABASE_URL}/rest/v1/slots?id=eq.${empty.id}`, {
          method: 'PATCH',
          headers: { ...supabaseHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ clan, clan_logo: currentLogoBase64, cancel_key: pin }),
        });
        showPopup('Reserved!');
        clanModal.style.display = 'none';
        loadSlots();
      } catch (e) { showPopup('Error!'); } finally { clanSubmitBtn.disabled = false; }
    }

    async function loadSlots() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/slots?select=id,slot_number,clan,clan_logo&schedule_type=eq.${currentSched}&order=slot_number.asc`, { headers: supabaseHeaders() });
        const data = await res.json();
        currentSlots = data.map(r => ({ id: r.id, slot: r.slot_number, clan: r.clan, logo: r.clan_logo }));
        slotsEl.innerHTML = '';
        for (let i = 1; i <= MAX_SLOTS; i++) {
          const s = currentSlots.find(x => x.slot === i);
          const div = document.createElement('div');
          div.className = 'slot ' + (s && s.clan ? 'filled' : 'empty');
          div.innerHTML = s && s.clan
            ? `<div class="slot-logo">${s.logo ? `<img src="${s.logo}">` : 'üõ°Ô∏è'}</div><div class="num">Slot ${i}</div><div class="clan">${s.clan}</div>`
            : `<div class="num">Slot ${i}</div><div class="clan">EMPTY</div>`;
          slotsEl.appendChild(div);
        }
      } catch (e) { console.error(e); }
    }

    function formatTime(t24) {
      if (!t24) return '';
      const [h, m] = t24.split(':');
      let hh = parseInt(h); const ampm = hh >= 12 ? 'PM' : 'AM';
      hh = hh % 12 || 12; return `${hh}:${m} ${ampm}`;
    }

    async function checkStatus() {
      try {
        const keys = [`${currentSched}_is_open`, `${currentSched}_sched_start`, `${currentSched}_sched_end`].join(',');
        const res = await fetch(`${SUPABASE_URL}/rest/v1/config?key=in.(${keys})&select=key,value`, { headers: supabaseHeaders() });
        const rows = await res.json();
        let isOp = 'false', sStart = '', sEnd = '';
        rows.forEach(r => {
          if (r.key === `${currentSched}_is_open`) isOp = r.value;
          if (r.key === `${currentSched}_sched_start`) sStart = r.value;
          if (r.key === `${currentSched}_sched_end`) sEnd = r.value;
        });
        const isOpenManual = isOp === 'true' || isOp === '1';

        // Parse times for countdown
        openTime = sStart ? { h: parseInt(sStart.split(':')[0]), m: parseInt(sStart.split(':')[1]) } : null;
        closeTime = sEnd ? { h: parseInt(sEnd.split(':')[0]), m: parseInt(sEnd.split(':')[1]) } : null;

        let isOpenSched = false;
        if (openTime && closeTime) {
          const now = new Date();
          const currentMins = now.getHours() * 60 + now.getMinutes();
          const startMins = openTime.h * 60 + openTime.m;
          const endMins = closeTime.h * 60 + closeTime.m;
          isOpenSched = startMins <= endMins ? (currentMins >= startMins && currentMins < endMins) : (currentMins >= startMins || currentMins < endMins);
        }

        isCurrentlyOpen = isOpenManual || isOpenSched;
        statusBanner.className = isCurrentlyOpen ? 'open' : 'closed';
        statusText.textContent = isCurrentlyOpen ? 'RESERVATIONS OPEN' : 'RESERVATIONS CLOSED';
        mineBtn.disabled = !isCurrentlyOpen;

        updateCountdown();
      } catch (e) { console.error(e); }
    }

    function updateCountdown() {
      if (!openTime || !closeTime) {
        countdownText.textContent = isCurrentlyOpen ? "Manual override active" : "Wait for admin to open";
        return;
      }

      const now = new Date();
      const currentSecs = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
      const startSecs = openTime.h * 3600 + openTime.m * 60;
      const endSecs = closeTime.h * 3600 + closeTime.m * 60;

      let targetSecs;
      if (isCurrentlyOpen) {
        targetSecs = endSecs;
        if (targetSecs < currentSecs) targetSecs += 24 * 3600; // Next day
        let diff = targetSecs - currentSecs;
        countdownText.textContent = `Closes in ${formatDiff(diff)}`;
      } else {
        targetSecs = startSecs;
        if (targetSecs < currentSecs) targetSecs += 24 * 3600; // Next day
        let diff = targetSecs - currentSecs;
        countdownText.textContent = `Opens in ${formatDiff(diff)}`;
      }
    }

    function formatDiff(s) {
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${h}h ${m}m ${sec}s`;
    }

    setInterval(updateCountdown, 1000);
    setInterval(checkStatus, 15000);
    setInterval(loadSlots, 3000);
    loadSlots(); checkStatus();
  </script>
</body>

</html>
