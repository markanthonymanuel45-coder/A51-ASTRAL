<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CODM Scrim Admin Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #020617 0%, #020617 45%, #000 100%);
      color: #e5e7eb;
      min-height: 100vh;
    }

    .page {
      max-width: 1100px;
      margin: 32px auto 40px;
      padding: 0 16px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: 0.03em;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
    }

    .badge-admin {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: rgba(248, 113, 113, 0.08);
      border: 1px solid rgba(248, 113, 113, 0.4);
      color: #fecaca;
    }

    /* Layout with side panel */
    .layout {
      display: grid;
      grid-template-columns: 210px minmax(0, 1fr);
      gap: 18px;
      align-items: flex-start;
    }

    .sidebar {
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.18), rgba(15, 23, 42, 0.96));
      border-radius: 18px;
      padding: 14px 12px 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.95);
      height: 100%;
    }

    .sidebar-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .sidebar-item {
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 13px;
      border: 1px solid transparent;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
    }

    .sidebar-item span {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      opacity: 0.8;
    }

    .sidebar-item.active {
      background: rgba(37, 99, 235, 0.3);
      border-color: rgba(129, 140, 248, 0.9);
      color: #e5e7eb;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.5);
      transform: translateY(-1px);
    }

    .sidebar-item:not(.active):hover {
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      border-color: rgba(55, 65, 81, 0.9);
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.9);
    }

    .main-view {
      min-width: 0;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.14), rgba(15, 23, 42, 0.96));
      border-radius: 18px;
      padding: 18px 18px 14px;
      box-shadow: 0 22px 55px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      margin-bottom: 18px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      font-size: 13px;
    }

    .field {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .field label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }

    .field input {
      border: none;
      outline: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 13px;
      min-width: 80px;
    }

    .field input::placeholder {
      color: #6b7280;
    }

    .metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
    }

    .metric-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #e5e7eb;
    }

    .metric-pill span {
      font-weight: 600;
      color: #f9fafb;
    }

    .slot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 6px;
      max-height: 430px;
      overflow: auto;
      padding-right: 2px;
    }

    .slot-card {
      border-radius: 12px;
      padding: 10px 10px 9px;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 118, 110, 0.4));
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .slot-card.empty {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(55, 65, 81, 0.7));
      border-style: dashed;
      opacity: 0.8;
    }

    .slot-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #9ca3af;
    }

    .slot-number {
      font-weight: 600;
      color: #e5e7eb;
    }

    .slot-status {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 1);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 9px;
    }

    .slot-status.filled {
      border-color: rgba(52, 211, 153, 0.9);
      color: #bbf7d0;
      background: rgba(6, 95, 70, 0.4);
    }

    .slot-status.empty {
      border-color: rgba(148, 163, 184, 0.9);
      color: #e5e7eb;
      background: rgba(31, 41, 55, 0.9);
    }

    .slot-clan {
      font-size: 13px;
      font-weight: 600;
      color: #f9fafb;
      word-break: break-word;
    }

    .slot-tag {
      font-size: 11px;
      color: #9ca3af;
    }

    .footer {
      margin-top: 18px;
      font-size: 11px;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      padding: 7px 14px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
    }

    .btn-ghost {
      background: transparent;
      color: #9ca3af;
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .btn-ghost:hover {
      background: rgba(31, 41, 55, 0.9);
      color: #e5e7eb;
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.9);
    }

    .btn-danger {
      background: #ef4444;
      color: #0b0f14;
      border: 1px solid rgba(239, 68, 68, 0.9);
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(239, 68, 68, 0.5);
    }

    .btn-update {
      background: #3b82f6;
      color: #0b0f14;
      border: 1px solid rgba(59, 130, 246, 0.9);
    }

    .btn-update:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.5);
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .chip {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
    }

    .chip strong {
      color: #a5b4fc;
    }

    /* Admin toast + popup (replace browser alerts/prompts) */
    .admin-toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
      padding: 7px 12px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 3000;
    }

    .admin-toast.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .admin-toast.success {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    .admin-toast.error {
      border-color: #f97316;
      color: #fed7aa;
    }

    .admin-popup {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2500;
    }

    .admin-popup-content {
      background: radial-gradient(circle at top, #1f2933 0%, #020617 55%);
      padding: 22px 20px 18px;
      border-radius: 16px;
      width: 320px;
      text-align: center;
      box-shadow: 0 22px 55px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .admin-popup-content h3 {
      margin: 0 0 8px;
      font-size: 16px;
      color: #bfdbfe;
    }

    .admin-popup-message {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .admin-popup-input {
      width: 92%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      margin: 0 auto 10px;
      font-size: 13px;
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, transform 0.15s ease;
      display: none;
    }

    .admin-popup-input:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.55), 0 10px 30px rgba(15, 23, 42, 0.7);
      background: rgba(15, 23, 42, 1);
      transform: translateY(-1px);
    }

    .admin-popup-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 6px;
    }

    .admin-popup-buttons button {
      flex: 1;
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
    }

    .admin-popup-confirm {
      background: #3b82f6;
      color: #0b0f14;
    }

    .admin-popup-confirm:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.5);
    }

    .admin-popup-cancel {
      background: #e5e7eb;
      color: #0b0f14;
    }

    .admin-popup-cancel:hover {
      background: #f3f4f6;
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.7);
    }

    @media (max-width: 640px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .sidebar {
        order: -1;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="layout">
      <aside class="sidebar">
        <div class="sidebar-title">Admin Panel</div>
        <div class="sidebar-nav">
          <button id="navScrim" class="sidebar-item active">
            Scrim Slots
            <span></span>
          </button>
          <button id="navScoreboard" class="sidebar-item">
            Scoreboard
            <span></span>
          </button>
        </div>
      </aside>

      <div class="main-view">
        <header>
          <div class="title-block">
            <h1>Scrim Slots ¬∑ Admin</h1>
            <div class="subtitle" id="viewSubtitle">Overview of all reserved slots and clan usage.</div>
          </div>
          <div style="display:flex; align-items:center; gap:10px;">
            <div class="badge-admin">
              <span>‚óè</span> ADMIN VIEW ONLY
            </div>
            <div
              style="font-size:11px; color:#9ca3af; display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
              <div>
                Reservations: <span id="reservationStatusLabel">‚Ä¶</span>
                <button id="toggleOpenBtn" class="btn btn-ghost"
                  style="margin-left:6px; padding:4px 10px; font-size:11px;">Toggle</button>
              </div>
              <div style="display: flex; gap: 6px; align-items: center;">
                Sched: <span id="scheduleStatusLabel" style="color:#bbf7d0;">None</span>
                <button id="scheduleBtn" class="btn btn-ghost" style="padding:4px 10px; font-size:11px;">Set
                  Sched</button>
              </div>
            </div>
          </div>
        </header>

        <!-- SCRIM SLOTS VIEW -->
        <div id="scrimView">
          <div class="card">
            <div class="card-header">
              <div class="filters">
                <div class="field">
                  <label for="searchClan">Search</label>
                  <input id="searchClan" type="text" placeholder="Clan or tag...">
                </div>
                <button id="refreshBtn" class="btn btn-ghost">Refresh</button>
                <button id="copySlotsBtn" class="btn btn-ghost">Copy Slots</button>
                <button id="resetBtnAdmin" class="btn btn-danger">Reset All Slots</button>
              </div>
              <div class="metrics">
                <div class="metric-pill">
                  Slots used: <span id="usedCount">0</span>/<span id="maxSlots">0</span>
                </div>
                <div class="metric-pill">
                  Unique clans: <span id="uniqueClans">0</span>
                </div>
              </div>
            </div>

            <div class="chips" id="topClans"></div>
            <div class="slot-grid" id="slotGrid"></div>

            <div class="footer">
              <div>Tip: Use the search box to quickly locate a specific clan or tag (e.g. "A51").</div>
            </div>
          </div>
        </div>

        <!-- SCOREBOARD VIEW -->
        <div id="scoreboardView" style="display:none;">
          <div class="card">
            <div class="card-header">
              <div style="font-size:14px; font-weight:600;">Scoreboard</div>
              <div class="metrics">
                <div class="metric-pill">
                  Teams shown here are pulled automatically from the scrim slots.
                </div>
                <button id="saveScoreboardBtn" class="btn btn-ghost" style="font-size:11px; padding:6px 10px;">
                  Save scoreboard
                </button>
                <button id="copyTopTeamsBtn" class="btn btn-update" style="font-size:11px; padding:6px 10px;">
                  Copy Top Teams
                </button>
              </div>
            </div>
            <div style="font-size:13px; color:#9ca3af; padding:4px 2px 10px 2px; margin-bottom:6px;">
              Team names are synced from the current scrim list so you don't have to type them again. Fill in round
              points and totals as needed.
            </div>

            <div style="overflow-x:auto;">
              <table style="width:100%; border-collapse:collapse; font-size:12px; min-width:520px;">
                <thead>
                  <tr style="background:rgba(15,23,42,0.95);">
                    <th style="padding:6px 4px; border-bottom:1px solid rgba(55,65,81,0.9);">Slot</th>
                    <th style="text-align:left; padding:6px 8px; border-bottom:1px solid rgba(55,65,81,0.9);">Team Name
                    </th>
                    <th style="padding:6px 4px; border-bottom:1px solid rgba(55,65,81,0.9);">R1</th>
                    <th style="padding:6px 4px; border-bottom:1px solid rgba(55,65,81,0.9);">PP1</th>
                    <th style="padding:6px 4px; border-bottom:1px solid rgba(55,65,81,0.9);">R2</th>
                    <th style="padding:6px 4px; border-bottom:1px solid rgba(55,65,81,0.9);">PP2</th>
                    <th style="padding:6px 4px; border-bottom:1px solid rgba(55,65,81,0.9);">R3</th>
                    <th style="padding:6px 4px; border-bottom:1px solid rgba(55,65,81,0.9);">PP3</th>
                    <th style="padding:6px 4px; border-bottom:1px solid rgba(55,65,81,0.9);">TOTAL</th>
                  </tr>
                </thead>
                <tbody id="scoreboardBody">
                  <!-- rows generated from scrim slots -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Schedule Popup -->
  <div class="admin-popup" id="schedulePopup">
    <div class="admin-popup-content">
      <h3 style="margin: 0 0 8px; font-size: 16px; color: #bfdbfe;">Set Schedule</h3>
      <div style="font-size: 12px; color: #9ca3af; margin-bottom: 10px;">Reservations will automatically open and close
        daily at these times.</div>
      <div style="display: flex; gap: 10px; margin-bottom: 14px;">
        <div style="flex: 1; text-align: left;">
          <label style="font-size: 11px; color: #9ca3af;">Open Time</label>
          <input type="time" id="schedStartTime"
            style="width: 100%; padding: 8px; border-radius: 8px; background: rgba(15, 23, 42, 0.9); border: 1px solid #475569; color: #e5e7eb; box-sizing: border-box; margin-top: 4px;">
        </div>
        <div style="flex: 1; text-align: left;">
          <label style="font-size: 11px; color: #9ca3af;">Close Time</label>
          <input type="time" id="schedEndTime"
            style="width: 100%; padding: 8px; border-radius: 8px; background: rgba(15, 23, 42, 0.9); border: 1px solid #475569; color: #e5e7eb; box-sizing: border-box; margin-top: 4px;">
        </div>
      </div>
      <div class="admin-popup-buttons">
        <button id="schedulePopupSave" class="admin-popup-confirm">Save</button>
        <button id="schedulePopupClear"
          style="background: #ef4444; color: #0b0f14; flex: 1; padding: 8px 10px; border-radius: 8px; border: none; font-weight: 600; font-size: 12px; cursor: pointer;">Clear</button>
        <button id="schedulePopupCancel" class="admin-popup-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Reusable admin popup (for confirmations / admin key) -->
  <div class="admin-popup" id="adminPopup">
    <div class="admin-popup-content">
      <h3 id="adminPopupTitle">Title</h3>
      <div id="adminPopupMessage" class="admin-popup-message"></div>
      <input type="text" id="adminPopupInput" class="admin-popup-input" placeholder="Admin key">
      <div class="admin-popup-buttons">
        <button id="adminPopupConfirm" class="admin-popup-confirm">Confirm</button>
        <button id="adminPopupCancel" class="admin-popup-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://yzdtszfubnastllfyczs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6ZHRzemZ1Ym5hc3RsbGZ5Y3pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNzEyOTgsImV4cCI6MjA4NzY0NzI5OH0.GJz1ouXTbi3GQZYJa0756w4CgqabT9C2EH_mW_m_5TY';
    const MAX_SLOTS = 25;

    const supabaseHeaders = () => ({
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
    });

    // Simple front-end guard: if not logged in, go to login page
    if (localStorage.getItem('codmAdminAuth') !== '1') {
      window.location.href = 'admin_login.html';
    }

    const slotGrid = document.getElementById('slotGrid');
    const usedCountEl = document.getElementById('usedCount');
    const maxSlotsEl = document.getElementById('maxSlots');
    const uniqueClansEl = document.getElementById('uniqueClans');
    const topClansEl = document.getElementById('topClans');
    const scoreboardBody = document.getElementById('scoreboardBody');
    const searchClanInput = document.getElementById('searchClan');
    const refreshBtn = document.getElementById('refreshBtn');
    const copySlotsBtn = document.getElementById('copySlotsBtn');
    const resetBtnAdmin = document.getElementById('resetBtnAdmin');

    const navScrim = document.getElementById('navScrim');
    const navScoreboard = document.getElementById('navScoreboard');
    const scrimView = document.getElementById('scrimView');
    const scoreboardView = document.getElementById('scoreboardView');
    const viewSubtitle = document.getElementById('viewSubtitle');
    const reservationStatusLabel = document.getElementById('reservationStatusLabel');
    const toggleOpenBtn = document.getElementById('toggleOpenBtn');
    const saveScoreboardBtn = document.getElementById('saveScoreboardBtn');
    const copyTopTeamsBtn = document.getElementById('copyTopTeamsBtn');

    const scheduleStatusLabel = document.getElementById('scheduleStatusLabel');
    const scheduleBtn = document.getElementById('scheduleBtn');
    const schedulePopup = document.getElementById('schedulePopup');
    const schedStartTime = document.getElementById('schedStartTime');
    const schedEndTime = document.getElementById('schedEndTime');
    const schedulePopupSave = document.getElementById('schedulePopupSave');
    const schedulePopupClear = document.getElementById('schedulePopupClear');
    const schedulePopupCancel = document.getElementById('schedulePopupCancel');

    const adminPopup = document.getElementById('adminPopup');
    const adminPopupTitle = document.getElementById('adminPopupTitle');
    const adminPopupMessage = document.getElementById('adminPopupMessage');
    const adminPopupInput = document.getElementById('adminPopupInput');
    const adminPopupConfirm = document.getElementById('adminPopupConfirm');
    const adminPopupCancel = document.getElementById('adminPopupCancel');

    let latestSlots = [];
    let latestScoreboardData = [];
    let adminPopupResolver = null;
    let currentSched = '8pm'; // DEFAULT VIEW

    function normalize(str) {
      return (str || '').toString().trim().toLowerCase();
    }

    // --- SCHEDULE SWITCHER UI ---
    function initSchedSwitcher() {
      const headerBlock = document.querySelector('.title-block');
      if (!headerBlock) return;

      const switcherDiv = document.createElement('div');
      switcherDiv.style.margin = '10px 0 0 0';
      switcherDiv.style.display = 'flex';
      switcherDiv.style.gap = '8px';

      const btn8 = document.createElement('button');
      btn8.className = 'btn btn-update';
      btn8.textContent = '8:00 PM View';
      btn8.style.padding = '5px 12px';

      const btn10 = document.createElement('button');
      btn10.className = 'btn btn-ghost';
      btn10.textContent = '10:00 PM View';
      btn10.style.padding = '5px 12px';

      const updateActive = () => {
        if (currentSched === '8pm') {
          btn8.className = 'btn btn-update';
          btn10.className = 'btn btn-ghost';
        } else {
          btn10.className = 'btn btn-update';
          btn8.className = 'btn btn-ghost';
        }
        if (typeof viewSubtitle !== 'undefined') {
          viewSubtitle.textContent = `Managing ${currentSched.toUpperCase()} Scrim data.`;
        }
      };

      btn8.onclick = () => { currentSched = '8pm'; updateActive(); loadAdminSlots(); checkGlobalStatus(); };
      btn10.onclick = () => { currentSched = '10pm'; updateActive(); loadAdminSlots(); checkGlobalStatus(); };

      switcherDiv.appendChild(btn8);
      switcherDiv.appendChild(btn10);
      headerBlock.appendChild(switcherDiv);
    }
    // Delay initialization to ensure DOM is ready
    setTimeout(initSchedSwitcher, 100);

    function showAdminToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = 'admin-toast';
      if (type === 'error') toast.classList.add('error');
      if (type === 'success') toast.classList.add('success');
      toast.textContent = message;
      document.body.appendChild(toast);
      requestAnimationFrame(() => {
        toast.classList.add('visible');
      });
      setTimeout(() => {
        toast.classList.remove('visible');
        setTimeout(() => toast.remove(), 250);
      }, 2200);
    }

    function openAdminPopup({ title, message, requireInput = false, placeholder = 'Admin key', initialValue = '', confirmText = 'Confirm', cancelText = 'Cancel' }) {
      adminPopupTitle.textContent = title || '';
      adminPopupMessage.textContent = message || '';
      adminPopupInput.value = initialValue || '';
      adminPopupInput.placeholder = placeholder || '';
      adminPopupInput.style.display = requireInput ? 'block' : 'none';
      adminPopupConfirm.textContent = confirmText;
      adminPopupCancel.textContent = cancelText;
      adminPopup.style.display = 'flex';
      if (requireInput) {
        setTimeout(() => adminPopupInput.focus(), 30);
      }
      return new Promise(resolve => {
        adminPopupResolver = resolve;
      });
    }

    adminPopupConfirm.onclick = () => {
      const value = adminPopupInput.style.display === 'none'
        ? null
        : (adminPopupInput.value || '').trim();
      adminPopup.style.display = 'none';
      if (adminPopupResolver) {
        adminPopupResolver({ confirmed: true, value });
        adminPopupResolver = null;
      }
    };

    adminPopupCancel.onclick = () => {
      adminPopup.style.display = 'none';
      if (adminPopupResolver) {
        adminPopupResolver({ confirmed: false, value: null });
        adminPopupResolver = null;
      }
    };

    async function loadAdminSlots() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/slots?select=id,slot_number,clan,schedule_type&schedule_type=eq.${currentSched}&order=slot_number.asc`, {
          headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` },
        });
        const data = await res.json();
        const list = Array.isArray(data) ? data : [];
        latestSlots = list.map(r => ({
          id: r.id,
          slot: r.slot_number,
          clan: r.clan || '',
          isFilled: !!(r.clan && r.clan.trim())
        }));

        // Fetch current scoreboard data to persist inputs
        const scoreRes = await fetch(`${SUPABASE_URL}/rest/v1/scoreboard?schedule_type=eq.${currentSched}&select=*`, {
          headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` },
        });
        const scoreData = await scoreRes.json();
        latestScoreboardData = Array.isArray(scoreData) ? scoreData : [];

        renderView();
      } catch (e) {
        console.error(e);
        showAdminToast("Failed to load slots.", 'error');
      }
    }

    function formatTime(t24) {
      if (!t24) return '';
      const [h, m] = t24.split(':');
      let hh = parseInt(h, 10);
      const ampm = hh >= 12 ? 'PM' : 'AM';
      hh = hh % 12 || 12;
      return `${hh}:${m} ${ampm}`;
    }

    async function checkGlobalStatus() {
      try {
        const keys = [`${currentSched}_is_open`, `${currentSched}_sched_start`, `${currentSched}_sched_end`].join(',');
        const res = await fetch(`${SUPABASE_URL}/rest/v1/config?key=in.(${keys})&select=key,value`, {
          headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` },
        });
        const rows = await res.json();
        let isOp = 'false', sStart = '', sEnd = '';
        rows.forEach(r => {
          if (r.key === `${currentSched}_is_open`) isOp = r.value;
          if (r.key === `${currentSched}_sched_start`) sStart = r.value;
          if (r.key === `${currentSched}_sched_end`) sEnd = r.value;
        });

        const val = isOp ? String(isOp).toLowerCase() : 'false';
        const isOpenManual = val === '1' || val === 'true' || val === 'yes';

        let isOpenSched = false;
        if (sStart && sEnd) {
          const now = new Date();
          const currentHMs = now.getHours() * 60 + now.getMinutes();
          const [sh, sm] = sStart.split(':').map(Number);
          const startMs = sh * 60 + sm;
          const [eh, em] = sEnd.split(':').map(Number);
          const endMs = eh * 60 + em;

          if (startMs <= endMs) {
            isOpenSched = currentHMs >= startMs && currentHMs <= endMs;
          } else {
            isOpenSched = currentHMs >= startMs || currentHMs <= endMs;
          }
        }

        const isOpen = isOpenManual || isOpenSched;
        let resStatusText = isOpen ? 'OPEN' : 'CLOSED';
        if (isOpen && sEnd && isOpenSched) {
          resStatusText += ` (Closes at ${formatTime(sEnd)})`;
        }

        reservationStatusLabel.textContent = resStatusText;
        reservationStatusLabel.style.color = isOpen ? '#4ade80' : '#f97316';

        toggleOpenBtn.textContent = isOpenManual ? 'Close manual toggle' : 'Open manual toggle';
        toggleOpenBtn.dataset.currentVal = isOpenManual ? 'open' : 'closed';

        if (sStart && sEnd) {
          scheduleStatusLabel.textContent = `${formatTime(sStart)} - ${formatTime(sEnd)}`;
          scheduleStatusLabel.style.color = '#bfdbfe';
        } else {
          scheduleStatusLabel.textContent = 'None';
          scheduleStatusLabel.style.color = '#9ca3af';
        }
      } catch (e) {
        console.error(e);
        reservationStatusLabel.textContent = 'Unknown';
        showAdminToast('Unable to fetch status.', 'error');
      }
    }

    scheduleBtn.onclick = async () => {
      try {
        const keys = [`${currentSched}_sched_start`, `${currentSched}_sched_end`].join(',');
        const res = await fetch(`${SUPABASE_URL}/rest/v1/config?key=in.(${keys})&select=key,value`, {
          headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` },
        });
        const data = await res.json();
        schedStartTime.value = data.find(r => r.key === `${currentSched}_sched_start`)?.value || '';
        schedEndTime.value = data.find(r => r.key === `${currentSched}_sched_end`)?.value || '';
        schedulePopup.style.display = 'flex';
      } catch (e) { showAdminToast("Failed to fetch schedule.", 'error'); }
    };

    schedulePopupSave.onclick = async () => {
      const s = schedStartTime.value;
      const e = schedEndTime.value;
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/config?key=eq.${currentSched}_sched_start`, {
          method: 'PATCH', headers: supabaseHeaders(), body: JSON.stringify({ value: s })
        });
        await fetch(`${SUPABASE_URL}/rest/v1/config?key=eq.${currentSched}_sched_end`, {
          method: 'PATCH', headers: supabaseHeaders(), body: JSON.stringify({ value: e })
        });
        showAdminToast(`${currentSched.toUpperCase()} schedule saved.`, 'success');
        schedulePopup.style.display = 'none';
        checkGlobalStatus();
      } catch (err) { showAdminToast("Failed to save schedule.", 'error'); }
    };

    schedulePopupClear.onclick = async () => {
      if (!confirm(`Clear schedule timer for ${currentSched.toUpperCase()}?`)) return;
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/config?key=eq.${currentSched}_sched_start`, {
          method: 'PATCH', headers: supabaseHeaders(), body: JSON.stringify({ value: '' })
        });
        await fetch(`${SUPABASE_URL}/rest/v1/config?key=eq.${currentSched}_sched_end`, {
          method: 'PATCH', headers: supabaseHeaders(), body: JSON.stringify({ value: '' })
        });
        showAdminToast("Timer cleared.", 'success');
        schedulePopup.style.display = 'none';
        checkGlobalStatus();
      } catch (err) { }
    };

    schedulePopupCancel.onclick = () => schedulePopup.style.display = 'none';

    schedulePopupSave.addEventListener('click', async () => {
      if (!schedStartTime.value || !schedEndTime.value) {
        showAdminToast('Please set both start and end time.', 'error');
        return;
      }
      await updateSchedConfig(schedStartTime.value, schedEndTime.value);
    });

    schedulePopupClear.addEventListener('click', async () => {
      await updateSchedConfig('', '');
    });

    function setActiveView(view) {
      if (view === 'scrim') {
        navScrim.classList.add('active');
        navScoreboard.classList.remove('active');
        scrimView.style.display = 'block';
        scoreboardView.style.display = 'none';
        viewSubtitle.textContent = 'Overview of all reserved slots and clan usage.';
      } else {
        navScrim.classList.remove('active');
        navScoreboard.classList.add('active');
        scrimView.style.display = 'none';
        scoreboardView.style.display = 'block';
        viewSubtitle.textContent = 'Scoreboard and standings overview.';
      }
    }

    function renderView() {
      const filter = normalize(searchClanInput.value);

      const withMeta = [];
      for (let i = 1; i <= MAX_SLOTS; i++) {
        const existing = latestSlots.find(x => x.slot === i);
        const clanName = existing && existing.clan ? existing.clan.toString() : '';
        const cleanName = clanName.trim();
        const isFilled = !!cleanName;
        const tag = cleanName ? cleanName.split(/\s+/)[0] : '';

        withMeta.push({
          slot: i,
          clan: cleanName,
          isFilled,
          tag,
          id: existing?.id
        });
      }

      let filtered = withMeta;
      if (filter) {
        filtered = withMeta.filter(s => {
          const name = normalize(s.clan);
          const tag = normalize(s.tag);
          return name.includes(filter) || tag.includes(filter) || String(s.slot).includes(filter);
        });
      }

      // metrics
      const filled = withMeta.filter(s => s.isFilled);
      usedCountEl.textContent = filled.length.toString();
      maxSlotsEl.textContent = MAX_SLOTS.toString();

      const clanCounts = {};
      filled.forEach(s => {
        const key = s.tag || s.clan || 'Unknown';
        const kNorm = key.toUpperCase();
        clanCounts[kNorm] = (clanCounts[kNorm] || 0) + 1;
      });
      const uniqueClans = Object.keys(clanCounts).length;
      uniqueClansEl.textContent = uniqueClans.toString();

      const top = Object.entries(clanCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);

      topClansEl.innerHTML = '';
      top.forEach(([name, count]) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = `${name} ¬∑ ${count} team${count > 1 ? 's' : ''}`;
        topClansEl.appendChild(chip);
      });

      // ---- Scoreboard rows (team list auto from scrim slots) ----
      if (scoreboardBody) {
        scoreboardBody.innerHTML = '';

        filled.forEach(s => {
          const tr = document.createElement('tr');
          tr.style.background = 'rgba(15,23,42,0.85)';

          const slotTd = document.createElement('td');
          slotTd.textContent = s.slot;
          slotTd.style.padding = '5px 8px';
          slotTd.style.textAlign = 'center';
          slotTd.style.borderBottom = '1px solid rgba(31,41,55,0.9)';
          tr.appendChild(slotTd);

          const nameTd = document.createElement('td');
          nameTd.textContent = s.clan;
          nameTd.style.padding = '5px 8px';
          nameTd.style.borderBottom = '1px solid rgba(31,41,55,0.9)';
          tr.appendChild(nameTd);

          const scoreInputs = [];

          // Find existing saved data for this team
          const existingScore = latestScoreboardData.find(d => d.team === s.clan);

          // helper to create editable score cells
          function addCell(val = '') {
            const td = document.createElement('td');
            td.style.padding = '4px 4px';
            td.style.textAlign = 'center';
            td.style.borderBottom = '1px solid rgba(31,41,55,0.9)';
            const input = document.createElement('input');
            input.type = 'text';
            input.value = val;
            input.style.width = '60px';
            input.style.padding = '4px 4px';
            input.style.borderRadius = '20px';
            input.style.border = '1px solid rgba(255,255,255,0.2)';
            input.style.background = 'rgba(15,23,42,0.95)';
            input.style.color = '#e5e7eb';
            input.style.fontSize = '10px';
            input.style.textAlign = 'center';
            input.style.outline = 'none';
            input.onfocus = () => input.style.borderColor = '#3b82f6';
            input.onblur = () => input.style.borderColor = 'rgba(255,255,255,0.2)';
            td.appendChild(input);
            tr.appendChild(td);
            scoreInputs.push(input);
          }

          // R1, PP1, R2, PP2, R3, PP3
          addCell(existingScore?.r1 || '');
          addCell(existingScore?.pp1 || '');
          addCell(existingScore?.r2 || '');
          addCell(existingScore?.pp2 || '');
          addCell(existingScore?.r3 || '');
          addCell(existingScore?.pp3 || '');

          // TOTAL cell (auto-calculated)
          const totalTd = document.createElement('td');
          totalTd.style.padding = '4px 4px';
          totalTd.style.textAlign = 'center';
          totalTd.style.borderBottom = '1px solid rgba(31,41,55,0.9)';
          const totalInput = document.createElement('input');
          totalInput.type = 'text';
          totalInput.value = existingScore?.total || '';
          totalInput.readOnly = false;
          totalInput.style.width = '60px';
          totalInput.style.padding = '4px 4px';
          totalInput.style.borderRadius = '20px';
          totalInput.style.border = '1px solid rgba(250,204,21,0.4)';
          totalInput.style.background = 'rgba(250,204,21,0.05)';
          totalInput.style.color = '#facc15';
          totalInput.style.fontWeight = '700';
          totalInput.style.fontSize = '11px';
          totalInput.style.textAlign = 'center';
          totalInput.style.outline = 'none';
          totalTd.appendChild(totalInput);
          tr.appendChild(totalTd);

          function recompute() {
            let sum = 0;
            let hasNumbers = false;
            let hasNoShow = false;

            scoreInputs.forEach(inp => {
              const raw = inp.value.trim().toUpperCase();
              if (raw === '') return;

              const val = parseInt(raw, 10);
              if (!isNaN(val)) {
                sum += val;
                hasNumbers = true;
              } else if (raw.includes('NS') || raw.includes('SHOW') || raw.includes('VOID') || raw === 'N/S') {
                hasNoShow = true;
              }
            });

            if (hasNumbers) {
              totalInput.value = sum;
            } else if (hasNoShow) {
              totalInput.value = '0';
            } else {
              totalInput.value = '';
            }
          }

          scoreInputs.forEach(inp => {
            inp.addEventListener('input', recompute);
            inp.addEventListener('change', recompute);
          });

          scoreboardBody.appendChild(tr);
        });
      }

      // slots
      slotGrid.innerHTML = '';
      filtered.forEach(s => {
        const card = document.createElement('div');
        card.className = 'slot-card ' + (s.isFilled ? '' : 'empty');

        const topRow = document.createElement('div');
        topRow.className = 'slot-top';
        const num = document.createElement('div');
        num.className = 'slot-number';
        num.textContent = 'Slot ' + s.slot;
        const status = document.createElement('div');
        status.className = 'slot-status ' + (s.isFilled ? 'filled' : 'empty');
        status.textContent = s.isFilled ? 'FILLED' : 'EMPTY';
        topRow.appendChild(num);
        topRow.appendChild(status);

        const clan = document.createElement('div');
        clan.className = 'slot-clan';
        clan.textContent = s.isFilled ? s.clan : '‚Äî';

        const tag = document.createElement('div');
        tag.className = 'slot-tag';
        tag.textContent = s.isFilled && s.tag ? 'Clan tag: ' + s.tag : '';

        card.appendChild(topRow);
        card.appendChild(clan);
        if (tag.textContent) {
          card.appendChild(tag);
        }

        // Admin can update or delete a filled slot directly from dashboard
        if (s.isFilled && s.clan) {
          const actionsDiv = document.createElement('div');
          actionsDiv.style.display = 'flex';
          actionsDiv.style.gap = '6px';
          actionsDiv.style.marginTop = '8px';

          const updateBtn = document.createElement('button');
          updateBtn.textContent = 'Update';
          updateBtn.className = 'btn btn-update';
          updateBtn.style.flex = '1';
          updateBtn.style.padding = '4px 8px';
          updateBtn.style.fontSize = '11px';
          updateBtn.onclick = async () => {
            const { confirmed, value } = await openAdminPopup({
              title: 'Update Clan Name',
              message: `Edit clan name for Slot ${s.slot}:`,
              requireInput: true,
              initialValue: s.clan,
              placeholder: 'New clan name',
              confirmText: 'Update',
              cancelText: 'Cancel'
            });
            if (!confirmed || !s.id) return;
            const newClan = (value || '').trim();
            if (!newClan) {
              showAdminToast('Clan name cannot be empty.', 'error');
              return;
            }

            try {
              const res = await fetch(`${SUPABASE_URL}/rest/v1/slots?id=eq.${s.id}`, {
                method: 'PATCH',
                headers: supabaseHeaders(),
                body: JSON.stringify({ clan: newClan }),
              });
              if (res.ok) {
                showAdminToast(`Slot ${s.slot} updated to "${newClan}".`, 'success');
                loadAdminSlots();
              } else {
                showAdminToast('Failed to update slot.', 'error');
              }
            } catch (e) {
              console.error(e);
              showAdminToast('Error while updating slot.', 'error');
            }
          };

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.className = 'btn btn-danger';
          deleteBtn.style.flex = '1';
          deleteBtn.style.padding = '4px 8px';
          deleteBtn.style.fontSize = '11px';
          deleteBtn.onclick = async () => {
            const { confirmed } = await openAdminPopup({
              title: 'Delete slot',
              message: `Delete slot ${s.slot} for "${s.clan}"?`,
              requireInput: false,
              confirmText: 'Delete',
              cancelText: 'Cancel'
            });
            if (!confirmed || !s.id) return;
            try {
              const res = await fetch(`${SUPABASE_URL}/rest/v1/slots?id=eq.${s.id}`, {
                method: 'PATCH',
                headers: supabaseHeaders(),
                body: JSON.stringify({ clan: null }),
              });
              if (res.ok) {
                showAdminToast(`Slot ${s.slot} deleted.`, 'success');
                loadAdminSlots();
              } else {
                showAdminToast('Failed to delete slot.', 'error');
              }
            } catch (e) {
              console.error(e);
              showAdminToast('Error while deleting slot.', 'error');
            }
          };

          actionsDiv.appendChild(updateBtn);
          actionsDiv.appendChild(deleteBtn);
          card.appendChild(actionsDiv);
        }

        slotGrid.appendChild(card);
      });
    }

    // events
    searchClanInput.addEventListener('input', () => {
      renderView();
    });

    refreshBtn.addEventListener('click', () => {
      loadAdminSlots();
    });

    copySlotsBtn.addEventListener('click', async () => {
      let text = "‚ÄºÔ∏èùë®51 ùë©ùëπ ùë∫ùë™ùëπùë∞ùë¥ùë¥ùë∞ùë¥ùë®ùëÆùë¨‚ÄºÔ∏è\n\n\nùë∫ùë≥ùë∂ùëªùë∫ ùë≥ùë∞ùë∫ùëª :\n";
      for (let i = 1; i <= MAX_SLOTS; i++) {
        const existing = latestSlots.find(x => x.slot === i);
        const clanName = existing && existing.clan ? existing.clan.trim() : '';
        text += `${i}. ${clanName}\n`;
      }

      text += "\n\nùôºùô¥ùôΩùöÉùô∏ùôæùôΩ ùöÉùô∑ùô¥ ùô∞ùô≥ùôºùô∏ùôΩùöÇ ùô∏ùôµ ùöÉùô∑ùô¥ùöÅùô¥ ùô∏ùöÇ ùô∞ ùô≤ùô∑ùô∞ùôΩùô∂ùô∏ùôΩùô∂. \nùô≥ùôæ ùôΩùôæùöÉ ùô¥ùô≥ùô∏ùöÉ!\n\n\nüö´ ùë©ùë®ùëµùëµùë¨ùë´ ùëªùë¨ùë®ùë¥ùë∫  (ùó°ùó¢ùó¶ùóõùó¢ùó™) 5 SCRIMS:   \n\n\n\n‚ÄºÔ∏èùóüùóîùóßùóò ùóñùóîùó°ùóñùóòùóüùóüùóîùóßùóúùó¢ùó°‚ÄºÔ∏è\nüö´BANNED 3 SCRIMSüëΩ\n-\n \nùöÅùöÑùôªùô¥ùöÇ! ‚¨áÔ∏è\nhttps://www.facebook.com/share/p/1EBXVRzz83/";

      try {
        await navigator.clipboard.writeText(text);
        showAdminToast("Slots copied to clipboard!", 'success');
      } catch (err) {
        console.error('Failed to copy text: ', err);
        // Fallback for older browsers
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
          document.execCommand('copy');
          showAdminToast("Slots copied to clipboard!", 'success');
        } catch (err2) {
          showAdminToast("Failed to copy slots.", 'error');
        }
        document.body.removeChild(textArea);
      }
    });

    resetBtnAdmin.addEventListener('click', async () => {
      const { confirmed } = await openAdminPopup({
        title: 'Reset all slots',
        message: 'Clear all slot reservations? This cannot be undone.',
        requireInput: false,
        confirmText: 'Reset',
        cancelText: 'Cancel'
      });
      if (!confirmed) return;
      try {
        for (const row of latestSlots) {
          if (row.id) {
            await fetch(`${SUPABASE_URL}/rest/v1/slots?id=eq.${row.id}`, {
              method: 'PATCH',
              headers: supabaseHeaders(),
              body: JSON.stringify({ clan: null }),
            });
          }
        }
        // Also clear the scoreboard data for this schedule
        await fetch(`${SUPABASE_URL}/rest/v1/scoreboard?schedule_type=eq.${currentSched}`, {
          method: 'DELETE', headers: supabaseHeaders()
        });

        showAdminToast("All slots and scores reset.", 'success');
        loadAdminSlots();
      } catch (e) {
        console.error(e);
        showAdminToast("Error while resetting.", 'error');
      }
    });

    saveScoreboardBtn.onclick = async () => {
      const rows = [];
      scoreboardBody.querySelectorAll('tr').forEach(tr => {
        const cells = tr.querySelectorAll('td');
        if (cells.length < 8) return;
        const team = cells[1].textContent;
        const getVal = (idx) => cells[idx].querySelector('input')?.value.trim() || '';
        rows.push({
          team, r1: getVal(2), pp1: getVal(3), r2: getVal(4), pp2: getVal(5), r3: getVal(6), pp3: getVal(7), total: getVal(8),
          schedule_type: currentSched
        });
      });

      if (!rows.length) return showAdminToast("Nothing to save.", 'info');
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/scoreboard?schedule_type=eq.${currentSched}`, {
          method: 'DELETE', headers: supabaseHeaders()
        });
        const res = await fetch(`${SUPABASE_URL}/rest/v1/scoreboard`, {
          method: 'POST', headers: supabaseHeaders(), body: JSON.stringify(rows)
        });
        if (res.ok) {
          showAdminToast(`${currentSched.toUpperCase()} Scoreboard Saved!`, 'success');
          // Update local data so "Copy Top Teams" is accurate
          latestScoreboardData = rows;
          fetch('https://api.github.com/repos/markanthonymanuel45-coder/A51-ASTRAL/dispatches', {
            method: 'POST',
            headers: { Authorization: 'token ghp_82233827382', Accept: 'application/vnd.github.v3+json' },
            body: JSON.stringify({ event_type: 'scoreboard_updated' })
          }).catch(() => { });
        }
      } catch (e) { showAdminToast("Save failed.", 'error'); }
    };

    copyTopTeamsBtn.onclick = async () => {
      // Get data from the UI rows
      const rows = [];
      scoreboardBody.querySelectorAll('tr').forEach(tr => {
        const cells = tr.querySelectorAll('td');
        if (cells.length < 9) return;
        const team = cells[1].textContent;
        const total = parseInt(cells[8].querySelector('input')?.value || '0', 10);
        if (team && team !== '‚Äî') {
          rows.push({ team, total });
        }
      });

      if (rows.length === 0) {
        showAdminToast("No scoreboard data found.", "error");
        return;
      }

      // Sort by total points descending
      rows.sort((a, b) => b.total - a.total);

      const top1 = rows[0]?.team || "";
      const top2 = rows[1]?.team || "";
      const top3 = rows[2]?.team || "";

      // Dynamic month/year
      const now = new Date();
      const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
      const currentMonth = monthNames[now.getMonth()];
      const currentYear = now.getFullYear();

      let text = `üëΩùêÇùêéùêçùêÜùêëùêÄùêìùêîùêãùêÄùêìùêàùêéùêçùêí ùêìùêé ùêìùêáùêÑ ùêìùêéùêè ùêìùêÑùêÄùêåùêí üëΩ\n\n`;
      text += `${currentMonth} , ${currentYear} | ${currentSched.toUpperCase()}\n`;
      text += `ü•á ùêìùêéùêè ùüè: ${top1}\n`;
      text += `ü•à ùêìùêéùêè ùüê: ${top2}\n`;
      text += `ü•â ùêìùêéùêè ùüë: ${top3}\n\n`;
      text += `üéñÔ∏è ùêåùêïùêè: \n\n`;
      text += `ùôãùôáùôÄùòºùôéùôÄ ùôéùôÄùôâùòø ùôîùôäùôêùôç ùôáùôäùôÇùôäùôé ùòºùôâùòø ùôàùôëùôã ùôãùôÑùòæùôé ùôÉùôÄùôçùôÄ.üëΩ`;

      try {
        await navigator.clipboard.writeText(text);
        showAdminToast("Top Teams copied to clipboard!", "success");
      } catch (err) {
        console.error('Failed to copy text: ', err);
        showAdminToast("Failed to copy text.", "error");
      }
    };

    toggleOpenBtn.addEventListener('click', async () => {
      const isCurrentlyManualOpen = toggleOpenBtn.dataset.currentVal === 'open';
      const makeOpen = !isCurrentlyManualOpen;
      const { confirmed } = await openAdminPopup({
        title: makeOpen ? `Open ${currentSched.toUpperCase()} manually` : `Close ${currentSched.toUpperCase()} manually`,
        message: makeOpen ? `Open reservations for ${currentSched.toUpperCase()}?` : `Close reservations for ${currentSched.toUpperCase()}?`,
        requireInput: false,
        confirmText: makeOpen ? 'Open' : 'Close',
        cancelText: 'Cancel'
      });
      if (!confirmed) return;
      try {
        const value = makeOpen ? 'true' : 'false';
        const res = await fetch(`${SUPABASE_URL}/rest/v1/config?key=eq.${currentSched}_is_open`, {
          method: 'PATCH',
          headers: supabaseHeaders(),
          body: JSON.stringify({ value }),
        });
        if (res.ok) {
          await checkGlobalStatus();
          showAdminToast(`${currentSched.toUpperCase()} status updated.`, 'success');
        }
      } catch (e) {
        console.error(e);
        showAdminToast('Error updating status.', 'error');
      }
    });

    navScrim.addEventListener('click', () => setActiveView('scrim'));
    navScoreboard.addEventListener('click', () => setActiveView('scoreboard'));

    setActiveView('scrim');
    loadAdminSlots();
    checkGlobalStatus();

    // Auto-refresh scrim slots every 8 seconds so admin sees new mines
    setInterval(() => {
      if (scrimView.style.display !== 'none') {
        loadAdminSlots();
      }
    }, 8000);
    setInterval(checkGlobalStatus, 15000);
  </script>
</body>

</html>
