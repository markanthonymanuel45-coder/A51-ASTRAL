<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CODM Scrim Slot Reservation</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg, #0b0f14 0%, #05060a 100%);
      color: #e6eef8;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 960px;
      margin: 40px auto;
      padding: 24px;
      background: linear-gradient(180deg, #0f1720, #071019);
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
    }

    h2 {
      text-align: center;
      font-size: 28px;
      margin-bottom: 20px;
      color: #2ecc71;
      text-shadow: 0 0 6px rgba(46, 204, 113, 0.5);
    }

    .buttons {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    button {
      padding: 12px 20px;
      font-weight: 700;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }

    #mineBtn {
      background: #2ecc71;
      color: #0b0f14;
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
    }

    #mineBtn:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    #cancelBtn {
      background: #e74c3c;
      color: #fff;
      margin-left: 10px;
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
    }

    #cancelBtn:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    #cancelBtn:disabled {
      background: #4b5563;
      cursor: not-allowed;
      box-shadow: none;
    }

    #slots {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .slot {
      background: rgba(255, 255, 255, 0.03);
      min-height: 80px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: 0.2s;
      font-weight: 600;
      text-align: center;
      box-shadow: inset 0 0 4px rgba(255, 255, 255, 0.05);
    }

    .slot.empty {
      background: linear-gradient(180deg, #39424a, #2c3238);
      color: #94a3b8;
    }

    .slot.filled {
      background: linear-gradient(180deg, #063a1b, #094b23);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .slot:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    .slot .num {
      font-weight: 700;
      font-size: 14px;
    }

    .slot .clan {
      font-size: 14px;
      margin-top: 4px;
      color: inherit;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 90%;
    }

    .slot-logo {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      border: 2px solid rgba(46, 204, 113, 0.3);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .slot-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Upload Preview in Modal */
    #logoPreviewContainer {
      width: 80px;
      height: 80px;
      margin: 10px auto 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.05);
      border: 2px dashed #94a3b8;
      display: none;
      /* hidden until logo uploaded ‚Äî JS sets to flex */
      justify-content: center;
      align-items: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: border-color 0.2s, background 0.2s;
      -webkit-tap-highlight-color: transparent;
      /* removes tap flash on mobile */
    }

    #logoPreviewContainer:hover {
      border-color: #2ecc71;
      background: rgba(46, 204, 113, 0.1);
    }

    #logoPreview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .upload-hint {
      font-size: 10px;
      color: #94a3b8;
      margin-bottom: 10px;
    }

    /* MODAL */
    #clanModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 32, 0.85);
      backdrop-filter: blur(6px);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #clanModalContent {
      background: radial-gradient(circle at top, #1f2933 0%, #020617 55%);
      padding: 20px 20px 16px;
      border-radius: 16px;
      width: 320px;
      text-align: center;
      position: relative;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    #clanModalContent h3 {
      color: #2ecc71;
      margin-bottom: 12px;
    }

    #clanInput {
      width: 92%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.8);
      color: #e6eef8;
      margin: 0 auto 10px;
      font-size: 14px;
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, transform 0.15s ease;
    }

    #clanInput::placeholder {
      color: #64748b;
    }

    #clanInput:focus {
      border-color: #2ecc71;
      box-shadow: 0 0 0 1px rgba(46, 204, 113, 0.45), 0 10px 30px rgba(15, 23, 42, 0.7);
      background: rgba(15, 23, 42, 1);
      transform: translateY(-1px);
    }

    #modalButtons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    #submitClan {
      flex: 1;
      background: #2ecc71;
      color: #0b0f14;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-weight: 700;
      cursor: pointer;
    }

    #cancelClan {
      flex: 1;
      background: #ccc;
      color: #0b0f14;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-weight: 700;
      cursor: pointer;
    }

    #submitClan,
    #cancelClan {
      transition: background 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
    }

    #submitClan:hover {
      background: #27ae60;
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(46, 204, 113, 0.4);
    }

    #cancelClan:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.7);
    }

    #successMessage {
      display: none;
      margin-top: 12px;
      color: #2ecc71;
      font-weight: 700;
    }

    /* Success Popup */
    .success-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #063a1b;
      border: 2px solid #2ecc71;
      color: #fff;
      padding: 20px 30px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      z-index: 2000;
      box-shadow: 0 8px 30px rgba(46, 204, 113, 0.4);
      animation: popupSlideIn 0.3s ease-out;
    }

    @keyframes popupSlideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -60%);
      }

      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    /* Success Popup */
    .success-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #063a1b;
      border: 2px solid #2ecc71;
      color: #fff;
      padding: 20px 30px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      z-index: 2000;
      box-shadow: 0 8px 30px rgba(46, 204, 113, 0.4);
      animation: popupSlideIn 0.3s ease-out;
    }

    @keyframes popupSlideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -60%);
      }

      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    @media(max-width:640px) {
      #slots {
        grid-template-columns: repeat(2, 1fr);
      }

      #clanModalContent {
        width: 92%;
        max-height: 90vh;
        overflow-y: auto;
        padding: 18px 16px;
      }

      #logoPreviewContainer {
        width: 90px;
        height: 90px;
      }

      .btn {
        min-height: 44px;
        /* Proper touch target size */
        font-size: 13px;
      }

      #cancelModalContent {
        width: 92%;
        max-height: 90vh;
        overflow-y: auto;
      }
    }

    /* Cancel Modal Radio Styles */
    #cancelClanList {
      text-align: left;
      margin: 15px auto;
      max-height: 250px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .clan-option {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .clan-option:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .clan-option input[type="radio"] {
      margin-right: 12px;
      accent-color: #e74c3c;
      transform: scale(1.2);
    }

    .clan-option span {
      font-size: 14px;
      color: #e6eef8;
    }

    #cancelSubmitBtn {
      background: #e74c3c;
      color: white;
    }

    #cancelSubmitBtn:hover {
      background: #c0392b;
      box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4);
    }

    /* Confirmation Modal Styles */
    #confirmModalContent {
      background: radial-gradient(circle at top, #1f2933 0%, #020617 55%);
      padding: 24px;
      border-radius: 16px;
      width: 300px;
      text-align: center;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(231, 76, 60, 0.3);
      animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .confirm-title {
      color: #e74c3c;
      font-size: 18px;
      margin-bottom: 12px;
      font-weight: 700;
    }

    .confirm-text {
      font-size: 14px;
      color: #cbd5e1;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .confirm-buttons {
      display: flex;
      gap: 12px;
    }

    .confirm-btn-yes {
      flex: 1;
      background: #e74c3c;
      color: white;
      padding: 10px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: 0.2s;
    }

    .confirm-btn-yes:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .confirm-btn-no {
      flex: 1;
      background: #4b5563;
      color: white;
      padding: 10px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: 0.2s;
    }

    .confirm-btn-no:hover {
      background: #374151;
      transform: translateY(-2px);
    }

    /* ‚îÄ‚îÄ Schedule Switcher ‚îÄ‚îÄ */
    .sched-switcher {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0;
      margin: 0 auto 22px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 50px;
      padding: 5px;
      width: fit-content;
    }

    .sched-btn {
      position: relative;
      padding: 9px 22px;
      border-radius: 50px;
      font-size: 13px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      background: transparent;
      color: #94a3b8;
      transition: color 0.25s;
      letter-spacing: 0.5px;
      z-index: 1;
    }

    .sched-btn.active {
      background: linear-gradient(135deg, #2ecc71, #16a085);
      color: #0b0f14;
      box-shadow: 0 4px 14px rgba(46, 204, 113, 0.45);
    }

    .sched-divider {
      width: 1px;
      height: 20px;
      background: rgba(255, 255, 255, 0.12);
      margin: 0 2px;
    }
  </style>
</head>

<body>

  <div class="container">
    <h2 id="pageTitle">ASTRAL 51 CODM Scrim Slot Reservation</h2>

    <!-- Schedule Fast-Switcher -->
    <div class="sched-switcher">
      <button class="sched-btn active" id="schedBtn8pm" onclick="switchSched('8pm')">
        üåô 8:00 PM
      </button>
      <div class="sched-divider"></div>
      <button class="sched-btn" id="schedBtn10pm" onclick="switchSched('10pm')">
        üåÉ 10:00 PM
      </button>
    </div>

    <div class="buttons">
      <button id="mineBtn">MINE SLOT</button>
      <button id="cancelBtn">CANCEL SLOT</button>
    </div>
    <div id="slots"></div>
    <div
      style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; font-size:11px; color:#6b7280;">
      <span id="statusText">Checking reservation status‚Ä¶</span>
    </div>

    <!-- MODAL -->
    <div id="clanModal">
      <div id="clanModalContent">
        <h3>Reserve Slot</h3>

        <div style="margin-bottom: 15px; text-align: left;">
          <label style="font-size: 12px; color: #94a3b8; display: block; margin-bottom: 5px;">Clan Name</label>
          <input type="text" id="clanInput" placeholder="Enter Clan Name" style="width: 100%; box-sizing: border-box;">
        </div>

        <div style="margin-bottom: 20px; text-align: left;">
          <label style="font-size: 12px; color: #94a3b8; display: block; margin-bottom: 5px;">Cancellation PIN (4
            Digits)</label>
          <input type="password" id="pinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            style="width: 100%; box-sizing: border-box; text-align: center; letter-spacing: 5px; font-size: 18px;">
          <small style="font-size: 10px; color: #64748b; display: block; margin-top: 5px;">Choose a PIN to protect your
            slot from being cancelled by others.</small>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
          <button id="uploadLogoBtn" class="btn btn-ghost" style="flex: 1; font-size: 11px;">
            <span id="uploadStatusText">CHANGE LOGO</span>
          </button>
          <input type="file" id="logoFile" accept="image/*" style="display:none">
        </div>

        <div id="logoPreviewContainer" onclick="logoFile.click()" title="Tap to change logo">
          <img id="logoPreview" src="" alt="">
        </div>
        <p class="upload-hint">Tap circle to change logo</p>

        <div style="display: flex; gap: 10px;">
          <button id="clanSubmitBtn" class="btn" style="flex: 2; background: #3b82f6;">SUBMIT</button>
          <button id="clanCancelBtn" class="btn btn-ghost" style="flex: 1;">CLOSE</button>
        </div>
      </div>
    </div>

    <!-- CANCEL MODAL -->
    <div id="cancelModal"
      style="display: none; position: fixed; inset: 0; background: rgba(15, 23, 32, 0.85); backdrop-filter: blur(6px); justify-content: center; align-items: center; z-index: 1000;">
      <div id="cancelModalContent"
        style="background: radial-gradient(circle at top, #1f2933 0%, #020617 55%); padding: 20px 20px 16px; border-radius: 16px; width: 320px; text-align: center; position: relative; box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9); border: 1px solid rgba(148, 163, 184, 0.4);">
        <h3>Cancel Reservation</h3>
        <p style="font-size: 12px; color: #94a3b8; margin-bottom: 15px;">Select your clan to cancel your slot:</p>
        <div id="cancelList"
          style="text-align: left; margin-bottom: 20px; max-height: 200px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
          <!-- Radio buttons will manifest here -->
        </div>

        <div id="pinVerificationSection"
          style="display:none; margin-top: 15px; text-align: left; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
          <label style="font-size: 12px; color: #94a3b8; display: block; margin-bottom: 5px;">Enter your 4-Digit PIN to
            verify:</label>
          <input type="password" id="cancelPinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            style="width: 100%; box-sizing: border-box; text-align: center; letter-spacing: 5px; font-size: 18px; margin-bottom: 15px;">
        </div>

        <div style="display: flex; gap: 10px;">
          <button id="cancelSubmitBtn" class="btn" style="flex: 2; background: #e74c3c;">SUBMIT CANCELLATION</button>
          <button id="cancelCloseBtn" class="btn btn-ghost" style="flex: 1;">CLOSE</button>
        </div>
      </div>
    </div>

    <!-- CUSTOM CONFIRMATION MODAL -->
    <div id="confirmModal"
      style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); justify-content: center; align-items: center; z-index: 2000;">
      <div id="confirmModalContent">
        <div class="confirm-title">Are you sure?</div>
        <div class="confirm-text" id="confirmMessage">Do you really want to cancel this reservation?</div>
        <div class="confirm-buttons">
          <button id="confirmYes" class="confirm-btn-yes">Yes, Cancel</button>
          <button id="confirmNo" class="confirm-btn-no">No, Go Back</button>
        </div>
      </div>
    </div>

    <script>
      const SUPABASE_URL = 'https://yzdtszfubnastllfyczs.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6ZHRzemZ1Ym5hc3RsbGZ5Y3pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNzEyOTgsImV4cCI6MjA4NzY0NzI5OH0.GJz1ouXTbi3GQZYJa0756w4CgqabT9C2EH_mW_m_5TY';
      const MAX_SLOTS = 25;

      const slotsEl = document.getElementById('slots');
      const clanModal = document.getElementById('clanModal');
      const clanInput = document.getElementById('clanInput');
      const pinInput = document.getElementById('pinInput');
      const logoFile = document.getElementById('logoFile');
      const uploadLogoBtn = document.getElementById('uploadLogoBtn');
      const uploadStatusText = document.getElementById('uploadStatusText');
      const logoPreview = document.getElementById('logoPreview');
      const logoPreviewContainer = document.getElementById('logoPreviewContainer');
      const clanSubmitBtn = document.getElementById('clanSubmitBtn');
      const submitClan = clanSubmitBtn; // alias ‚Äî code uses both names
      const clanCancelBtn = document.getElementById('clanCancelBtn');
      const mineBtn = document.getElementById('mineBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const statusText = document.getElementById('statusText');

      let currentLogoBase64 = ''; // Store the logo as string

      // Cancel Modal elements
      const cancelModal = document.getElementById('cancelModal');
      const cancelList = document.getElementById('cancelList');
      const cancelSubmitBtn = document.getElementById('cancelSubmitBtn');
      const cancelCloseBtn = document.getElementById('cancelCloseBtn');
      const cancelPinInput = document.getElementById('cancelPinInput');
      const pinVerificationSection = document.getElementById('pinVerificationSection');

      // Custom Confirmation Modal elements
      const confirmModal = document.getElementById('confirmModal');
      const confirmMessage = document.getElementById('confirmMessage');
      const confirmYes = document.getElementById('confirmYes');
      const confirmNo = document.getElementById('confirmNo');

      let currentSlotToMine = null; // Store slot ID when reserving
      let selectedSlotIdToCancel = null; // Store slot ID when cancelling
      let selectedSlotDetails = null; // Store details of the slot being cancelled

      // --- DUAL SCHEDULE LOGIC ---
      const urlParams = new URLSearchParams(window.location.search);
      let currentSched = urlParams.get('sched') || '8pm';
      if (currentSched !== '8pm' && currentSched !== '10pm') currentSched = '8pm';

      // Schedule Switcher Function
      function switchSched(sched) {
        currentSched = sched;

        // Update button active states
        document.getElementById('schedBtn8pm').classList.toggle('active', sched === '8pm');
        document.getElementById('schedBtn10pm').classList.toggle('active', sched === '10pm');

        // Update page title
        const title = document.getElementById('pageTitle');
        if (title) title.textContent = `A51 ASTRAL ${sched.toUpperCase()} Scrim Reservation`;

        // Reload slots for the new schedule
        loadSlots();
        checkStatus();
      }

      // Init active button based on URL param
      document.getElementById(`schedBtn${currentSched}`).classList.add('active');
      document.getElementById(`schedBtn${currentSched === '8pm' ? '10pm' : '8pm'}`).classList.remove('active');

      // Update Header on first load
      const pageTitle = document.getElementById('pageTitle');
      if (pageTitle) pageTitle.textContent = `A51 ASTRAL ${currentSched.toUpperCase()} Scrim Reservation`;

      // Holds latest slots data from the server
      let currentSlots = []; // Renamed from latestSlots for consistency

      // Helper for Supabase headers
      const supabaseHeaders = () => ({
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
      });

      // Show Modal
      mineBtn.onclick = async () => {
        // Find first empty slot
        const empty = currentSlots.find(s => !s.clan);
        if (!empty) {
          showPopup(`All slots full for ${currentSched.toUpperCase()}!`);
          return;
        }
        currentSlotToMine = empty.id;
        clanInput.value = '';
        pinInput.value = '';
        currentLogoBase64 = '';
        logoPreview.src = '';
        logoPreviewContainer.style.display = 'none';
        uploadStatusText.textContent = 'UPLOAD LOGO';
        clanSubmitBtn.disabled = false;
        clanSubmitBtn.textContent = 'SUBMIT';
        clanModal.style.display = 'flex';
        clanInput.focus();
      }

      // Handle Logo Upload, Resize and Preview
      uploadLogoBtn.onclick = () => logoFile.click();

      logoFile.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            showPopup('File too large! Max 5MB.');
            return;
          }
          const reader = new FileReader();
          reader.onload = (event) => {
            const dataUrl = event.target.result;

            // ‚úÖ Show preview IMMEDIATELY from FileReader (no canvas delay)
            logoPreview.src = dataUrl;
            logoPreviewContainer.style.display = 'flex';
            uploadStatusText.textContent = 'CHANGE LOGO';

            // Compress in background for saving to Supabase
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const MAX = 150;
              let w = img.width, h = img.height;
              if (w > h) { if (w > MAX) { h = h * MAX / w; w = MAX; } }
              else { if (h > MAX) { w = w * MAX / h; h = MAX; } }
              canvas.width = Math.round(w);
              canvas.height = Math.round(h);
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              currentLogoBase64 = canvas.toDataURL('image/jpeg', 0.65);
            };
            img.onerror = () => {
              // If canvas fails, use the raw data URL
              currentLogoBase64 = dataUrl;
            };
            img.src = dataUrl;
          };
          reader.onerror = () => showPopup('Could not read image file.');
          reader.readAsDataURL(file);
        }
      };

      // Cancel Modal
      clanCancelBtn.onclick = () => clanModal.style.display = 'none';

      // Cancel Slot Logic
      cancelBtn.onclick = async () => {
        try {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/slots?select=id,slot_number,clan,cancel_key&schedule_type=eq.${currentSched}&clan=neq.&clan=not.is.null&order=slot_number.asc`, {
            headers: supabaseHeaders(),
          });
          const filled = await res.json();

          if (!filled || filled.length === 0) {
            showPopup("No reservations to cancel!");
            return;
          }

          cancelList.innerHTML = '';
          filled.forEach(s => {
            const div = document.createElement('div');
            div.className = 'clan-option'; // Reusing existing style
            div.innerHTML = `
              <input type="radio" name="cancelSlot" id="slot_${s.id}" value="${s.id}" data-key="${s.cancel_key}" data-name="${s.clan}" data-num="${s.slot_number}">
              <label for="slot_${s.id}"><span><strong>Slot ${s.slot_number}:</strong> ${s.clan}</span></label>
            `;
            // Trigger PIN section when a selection is made
            div.querySelector('input').onchange = () => {
              pinVerificationSection.style.display = 'block';
              cancelPinInput.value = "";
              cancelPinInput.focus();
            };
            cancelList.appendChild(div);
          });

          cancelPinInput.value = "";
          pinVerificationSection.style.display = 'none';
          cancelModal.style.display = 'flex';
        } catch (e) {
          showPopup('Error loading clans: ' + e.message);
        }
      };

      cancelCloseBtn.onclick = () => {
        cancelModal.style.display = 'none';
      };

      cancelSubmitBtn.onclick = () => {
        const selected = document.querySelector('input[name="cancelSlot"]:checked');
        if (!selected) {
          showPopup("Please select a slot to cancel.");
          return;
        }

        const inputPin = cancelPinInput.value.trim();
        const correctPin = selected.getAttribute('data-key');

        if (inputPin !== correctPin) {
          showPopup("Incorrect PIN! You are not authorized to cancel this slot.");
          return;
        }

        selectedSlotIdToCancel = selected.value;
        const clanName = selected.getAttribute('data-name');
        const slotNum = selected.getAttribute('data-num');

        // Show our custom confirmation modal
        confirmMessage.innerHTML = `Are you sure you want to cancel <br><strong>Slot ${slotNum}: ${clanName}</strong>?`;
        confirmModal.style.display = 'flex';
      };

      confirmNo.onclick = () => {
        confirmModal.style.display = 'none';
        selectedSlotIdToCancel = null;
      };

      confirmYes.onclick = async () => {
        if (!selectedSlotIdToCancel) return;

        confirmYes.disabled = true;
        try {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/slots?id=eq.${selectedSlotIdToCancel}`, {
            method: 'PATCH',
            headers: {
              ...supabaseHeaders(),
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ clan: '', clan_logo: null, cancel_key: null }),
          });

          if (!res.ok) throw new Error('Failed to cancel reservation');

          showPopup('Reservation Cancelled!');
          confirmModal.style.display = 'none';
          cancelModal.style.display = 'none';
          selectedSlotIdToCancel = null;
          loadSlots();
        } catch (e) {
          showPopup('Error cancelling: ' + e.message);
        } finally {
          confirmYes.disabled = false;
        }
      };

      // Show Custom Popup
      function showPopup(message, duration = 1000) {
        const popup = document.createElement('div');
        popup.className = 'success-popup';
        popup.textContent = message;
        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), duration);
      }

      // Submit Clan
      submitClan.onclick = async () => {
        const clan = clanInput.value.trim();
        if (!clan) {
          showPopup('Enter a Clan Name!');
          return;
        }

        // Normalize for comparison (case-insensitive)
        const normalizedClan = clan.toUpperCase();
        const [normalizedTag] = normalizedClan.split(/\s+/);

        // Enforce: max 3 teams per clan tag and no exact duplicate team name
        // Use currentSlots (from last loadSlots) for validation
        const slotsForValidation = Array.isArray(currentSlots) ? currentSlots : [];
        if (slotsForValidation.length) {
          const existingNames = slotsForValidation
            .filter(s => s && s.clan)
            .map(s => s.clan.toString().trim().toUpperCase());

          // Reject exact duplicate team name
          if (existingNames.includes(normalizedClan)) {
            showPopup('That team name is already reserved.');
            return;
          }

          // Count how many teams share the same first word/tag (e.g. "A51")
          const sameTagCount = existingNames.filter(name => {
            const [tag] = name.split(/\s+/);
            return tag === normalizedTag;
          }).length;

          if (sameTagCount >= 3) {
            showPopup(`Only 3 teams allowed for clan ${normalizedTag}.`);
            return;
          }
        }
        submitClan.disabled = true;
        try {
          // Find first empty slot for the CURRENT schedule
          const listRes = await fetch(`${SUPABASE_URL}/rest/v1/slots?select=id,slot_number,clan,schedule_type&schedule_type=eq.${currentSched}&order=slot_number.asc`, {
            headers: {
              apikey: SUPABASE_KEY,
              Authorization: `Bearer ${SUPABASE_KEY}`,
            }
          });
          const list = await listRes.json();
          const emptyRow = list.find(r => !r.clan || r.clan.toString().trim() === '');
          if (!emptyRow) {
            showPopup(`All slots full for ${currentSched.toUpperCase()}!`);
            submitClan.disabled = false;
            return;
          }
          const pinValue = pinInput.value.trim();
          if (!pinValue || pinValue.length !== 4 || !/^\d{4}$/.test(pinValue)) {
            showPopup('Please enter a valid 4-digit PIN!');
            submitClan.disabled = false;
            return;
          }
          const res = await fetch(`${SUPABASE_URL}/rest/v1/slots?id=eq.${emptyRow.id}`, {
            method: 'PATCH',
            headers: {
              apikey: SUPABASE_KEY,
              Authorization: `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json',
              Prefer: 'return=representation',
            },
            body: JSON.stringify({ clan, clan_logo: currentLogoBase64, cancel_key: pinValue }),
          });
          if (!res.ok) {
            const errText = await res.text();
            if (errText && errText.toLowerCase().includes('duplicate') || res.status === 409) {
              showPopup('Clan already exists!');
            } else {
              showPopup('Something went wrong. Please try again.');
            }
            submitClan.disabled = false;
            return;
          }
          showPopup('Successfully Reserved!');
          clanInput.value = '';
          clanModal.style.display = 'none';
          submitClan.disabled = false;
          loadSlots();
        } catch (e) {
          showPopup('Error: ' + e.message);
          submitClan.disabled = false;
        }
      }

      // Load slots from Supabase for this schedule
      async function loadSlots() {
        try {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/slots?select=id,slot_number,clan,clan_logo,schedule_type&schedule_type=eq.${currentSched}&order=slot_number.asc`, {
            headers: {
              apikey: SUPABASE_KEY,
              Authorization: `Bearer ${SUPABASE_KEY}`,
            },
          });
          const data = await res.json();
          currentSlots = (Array.isArray(data) ? data : []).map(r => ({
            id: r.id,
            slot: r.slot_number,
            clan: r.clan || '',
            logo: r.clan_logo || '',
          }));

          slotsEl.innerHTML = '';
          for (let i = 1; i <= MAX_SLOTS; i++) {
            const s = currentSlots.find(x => x.slot === i);
            const clan = s && s.clan ? String(s.clan).trim() : '';
            const logo = s && s.logo ? s.logo : '';

            const div = document.createElement('div');
            div.className = 'slot ' + (clan ? 'filled' : 'empty');

            let logoHtml = '';
            if (clan) {
              logoHtml = `
                <div class="slot-logo">
                  ${logo ? `<img src="${logo}" alt="Logo">` : `<span style="font-size: 20px;">üõ°Ô∏è</span>`}
                </div>
              `;
            }

            div.innerHTML = `
              ${logoHtml}
              <div class="num">Slot ${i}</div>
              <div class="clan">${clan || 'EMPTY'}</div>
            `;
            slotsEl.appendChild(div);
          }
        } catch (e) {
          console.error(e);
        }
      }

      // Auto-refresh
      loadSlots();
      setInterval(loadSlots, 1000);

      function formatTime(t24) {
        if (!t24) return '';
        const [h, m] = t24.split(':');
        let hh = parseInt(h, 10);
        const ampm = hh >= 12 ? 'PM' : 'AM';
        hh = hh % 12 || 12;
        return `${hh}:${m} ${ampm}`;
      }

      // Check reservation open/closed status for this specific schedule
      async function checkStatus() {
        try {
          const keys = [`${currentSched}_is_open`, `${currentSched}_sched_start`, `${currentSched}_sched_end`].join(',');
          const res = await fetch(`${SUPABASE_URL}/rest/v1/config?key=in.(${keys})&select=key,value`, {
            headers: {
              apikey: SUPABASE_KEY,
              Authorization: `Bearer ${SUPABASE_KEY}`,
            },
          });
          if (!res.ok) throw new Error('Network response was not ok');
          const rows = await res.json();

          let isOp = 'false';
          let sStart = '';
          let sEnd = '';
          rows.forEach(r => {
            if (r.key === `${currentSched}_is_open`) isOp = r.value;
            if (r.key === `${currentSched}_sched_start`) sStart = r.value;
            if (r.key === `${currentSched}_sched_end`) sEnd = r.value;
          });

          const val = isOp ? String(isOp).toLowerCase() : 'false';
          const isOpenManual = val === '1' || val === 'true' || val === 'yes';

          let isOpenSched = false;
          if (sStart && sEnd) {
            const now = new Date();
            const currentHMs = now.getHours() * 60 + now.getMinutes();

            const [sh, sm] = sStart.split(':').map(Number);
            const startMs = sh * 60 + sm;

            const [eh, em] = sEnd.split(':').map(Number);
            const endMs = eh * 60 + em;

            if (startMs <= endMs) {
              isOpenSched = currentHMs >= startMs && currentHMs <= endMs;
            } else {
              // Schedule crosses midnight
              isOpenSched = currentHMs >= startMs || currentHMs <= endMs;
            }
          }

          const isOpen = isOpenManual || isOpenSched;

          if (isOpen) {
            mineBtn.disabled = false;
            mineBtn.textContent = 'MINE SLOT';
            let closeMsg = 'OPEN';
            if (sEnd) {
              closeMsg += ` (Closes at ${formatTime(sEnd)})`;
            }
            statusText.textContent = 'Reservation status: ' + closeMsg;
            statusText.style.color = '#4ade80';
          } else {
            mineBtn.disabled = true;
            mineBtn.textContent = 'RESERVATION CLOSED';
            statusText.textContent = 'Reservation status: CLOSED' + (sStart ? ` (Opens at ${formatTime(sStart)})` : ' (wait for admin to open)');
            statusText.style.color = '#f97316';
          }
        } catch (e) {
          console.error(e);
          statusText.textContent = 'Status error: ' + e.message;
          statusText.style.color = '#f97316';
        }
      }

      checkStatus();
      setInterval(checkStatus, 10000);
    </script>

</body>

</html>
